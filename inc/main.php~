<?php
if (isset($INFO['act'][$_REQUEST['act']]))
		{ $jl_act=$_REQUEST['act'];} else {$jl_act=$INFO['default_act'] ;};
# SEND BEGIN
if ($jl_act=="send") {
	$tpl->assign(array( "NAVIGATE"	=> ""));
if (isset($_REQUEST['P_F']) and isset($_REQUEST['P_T']) and isset($_REQUEST['P_M'])) {
$ip=getenv("REMOTE_ADDR");

// print_r($_REQUEST);
if (!isset($_REQUEST['sendlater'])) {
$tmpfname = tempnam("/var/www/gate/bin/", "msg");
$handle = fopen($tmpfname, "w");
 if ($USER['set_header'] != 0)
{
fwrite($handle, "From " .$ip. " # http://jlarky.info/gate" );
fwrite($handle, "\n");
};
//fwrite($handle, iconv("UTF-8", "KOI8-R", $_POST['P_M']) );
fwrite($handle, stripslashes($_POST['P_M'] ));

#$tmps=ereg_replace("_", "",ereg_replace("-", "", $_POST['P_F']));
#if (ctype_alnum( $tmps )) { $from=$_POST['P_F']; } else {$from=$ip;};
$from=escapeshellcmd($_REQUEST['P_F']);
#$tmps=ereg_replace("_", "",ereg_replace("-", "", $_POST['P_T']));
$to=escapeshellcmd($_REQUEST['P_T']);
$to=ereg_replace("\*", "14 15 16 ALTNET MSHOME NT WORKGROUP",$to);
$to=ereg_replace("\ ", "\" \"",$to);

#if ( $to=="*") { $to ="14 15 16 ALTNET KINDERGARDEN NT WORKGROUP";};
fclose($handle);
system("
export HOME=/home/jlarky
export LANG=ru_RU.UTF8
#| grep \"were sent\" 
ulimit -t 1
cat ".$tmpfname."| popupnicheg -n \"".$from."\" -H 0:e0:29:2e:82:88 -I 10.0.144.1 \"".$to."\" | grep \"were sent\" > ".$tmpfname.".txt # 2>&1
#cat ".$tmpfname."| popup_sender -d 5 -B 10.0.255.255 -n \"".$from."\" \"".$to."\" > ".$tmpfname.".txt 2>&1
");


$handle = fopen($tmpfname.".txt", "r");
$content = fread( $handle, filesize( $tmpfname.".txt" ));
fclose($handle);
unlink($tmpfname);
unlink($tmpfname.".txt");
} else {
if ($USER['user_perm'] >= 1) {
include "inc/sendlater.php";
if ( (isset($_REQUEST['P_T'])) and ($_REQUEST['P_T']!="") ) {
$content="Сообщение добавленно в очередь";
$tmp= new PopupSender($_REQUEST['P_T'], $_REQUEST['P_F'], "From " .$ip. " # http://jlarky.info/gate\n".$_REQUEST['P_M']);
} else 
{
$content="вазник эрор";
};
// $content="Счас всё будет";
} else {
$content="Извините Вам эта функция не доступна пользуйтесь кнопкой \"отправить\"";
} 
}
	$tpl->assign(array( "SENDLOG"	=> "<p align=center>".$content."<p>"));
	$tpl->assign(array( "MESSAGE"	=> stripslashes($_POST['P_M'])));
	$tpl->assign(array( "P_T"	=> htmlspecialchars($_REQUEST['P_T'])));
	$tpl->assign(array( "P_F"	=> htmlspecialchars($_REQUEST['P_F'])));
	$tpl->parse("CONTENT", array("send"));
} else {
	$tpl->assign(array( "SENDLOG"	=> ""));

if (@$_REQUEST['id'] != "") {

############
# SELECT FROM DB
  $s = @mysql_fetch_row(mysql_query("SELECT * FROM `".$INFO['base_tabl']. "`,`".$INFO['alias_tabl']."` WHERE  (`".$INFO['base_tabl']."`.id='" . intval($_GET['id']) . "') and ((UPPER(`".$INFO['base_tabl']. "`.dst_ntb)=UPPER(`".$INFO['alias_tabl']."`.name) and UPPER(`".$INFO['alias_tabl']."`.uid)='".$user_id."') or `dst_mac`='ff:ff:ff:ff:ff:ff')"));
  $s[8] = ">" . $s[8];
  $s[8] = str_replace("\r", "",$s[8]);
  $s[8] = str_replace("\n", "\n>",$s[8]);
  $s[8] = $s[8]."\r\n>\r\n";
  $s[8] = htmlspecialchars($s[8	]);
	$tpl->assign(array( "MESSAGE"	=> $s[8]));
	$tpl->assign(array( "P_T"	=> $s[3]));
	$tpl->assign(array( "P_F"	=> $user_name));

};

$tpl->parse("CONTENT", array("send"));
};
}; # SEND END

# GATE and PRIVATE BEGING
if ($jl_act=="gate" or $jl_act=="private" or $jl_act=="search2")
{
############
# SELECT FROM DB
  mysql_select_db($INFO['base_name']);
  mysql_query("SET NAMES 'utf8'") or die("Invalid query: " . mysql_error());

if ($jl_act=='private') {

if ($USER['user_perm']==0) {
	$tpl->assign(array( "CONTENT"	=> "{LOGIN}"));
	$tpl->parse("LOGIN", array("login"));
;}
else {
if ($USER['set_outgoing']) { # показывать ли исходящие сообщения
$outgoing="UPPER(`".$INFO['base_tabl']. "`.src_ntb)=UPPER(`".$INFO['alias_tabl']."`.name) and UPPER(`".$INFO['alias_tabl']."`.uid)='".$user_id."'";
} else {
$outgoing=0;
};
$query="SELECT * FROM `".$INFO['base_tabl']. "`,`".$INFO['alias_tabl']."` WHERE (UPPER(`".$INFO['base_tabl']. "`.dst_ntb)=UPPER(`".$INFO['alias_tabl']."`.name) and UPPER(`".$INFO['alias_tabl']."`.uid)='".$user_id."') or ($outgoing and `dst_mac`!='ff:ff:ff:ff:ff:ff') ORDER BY `".$INFO['base_tabl']. "`.id DESC LIMIT " . $c . ", ".$mpopups;
};
} else {$query="SELECT * FROM ".$INFO['base_tabl']. " WHERE dst_mac='ff:ff:ff:ff:ff:ff' ORDER BY id DESC LIMIT " . $c . ", $mpopups";};

if ($USER['user_id'] == 1 and $jl_act=="search2") {
$who=$_REQUEST['who'];
$query="SELECT * FROM ".$INFO['base_tabl']. " WHERE ( ((UPPER(src_ntb)='JLARKY' or UPPER(src_ntb)='PROXY') and UPPER(dst_ntb)=UPPER('$who')) or ((UPPER(dst_ntb)='JLARKY' or UPPER(dst_ntb)='PROXY') and UPPER(src_ntb)=UPPER('$who')) ) and dst_mac!='ff:ff:ff:ff:ff:ff' ORDER BY id DESC LIMIT " . $c . ", $mpopups";
};
  if (isset($query)) {
$e = mysql_query($query) or die("Invalid query: " . mysql_error());

	include "popups.php";
	$tpl->assign(array( "CONTENT"	=> "{POPUPS}"));
};
}; # GATE and PRIVATE END

# ABOUT BEGIN
if ($jl_act=="about") {
	$tpl->assign(array( "NAVIGATE"	=> ""));
$text="";
$s = @mysql_fetch_row(mysql_query("SELECT * FROM ".$INFO['texts_tabl']." WHERE `id`='1'"));
if (isset($s[1])) {
$text=$s[1];
}
	$tpl->assign(array( "CONTENT"	=> $text));
}; # ABOUT END



# BROWSE BEGING
if ($jl_act=="browse")
{

$s = @mysql_fetch_row(mysql_query("SELECT MAX(`id`) FROM ".$INFO['base_tabl']));
if (isset($s[0])) {
$cmax=intval($s[0]);
} else {
$cmax=0;
};
//$tpl->assign( array( "CP" => $c-1));
//$tpl->assign( array( "CN" => $c+1));
//$tpl->assign( array( "C" => $cmax));
//	$tpl->parse("NAVIGATE", array("navigate"));


############
# SELECT FROM DB
  mysql_select_db($INFO['base_name']);
  mysql_query("SET NAMES 'utf8'") or die("Invalid query: " . mysql_error());


$query="SELECT MAX(`".$INFO['base_tabl']."`.`id`) FROM `".$INFO['base_tabl']. "`,`".$INFO['alias_tabl']."` WHERE ((UPPER(`".$INFO['base_tabl']. "`.dst_ntb)=UPPER(`".$INFO['alias_tabl']."`.name) and UPPER(`".$INFO['alias_tabl']."`.uid)='".$user_id."') or `dst_mac`='ff:ff:ff:ff:ff:ff') limit 1";
//$e = mysql_query($query);
//$s = @mysql_fetch_row($e);
$cmax=intval($s[0]);

$_REQUEST['c']=min($_REQUEST['c'], $cmax);
$query="SELECT MIN(`".$INFO['base_tabl']."`.`id`)
 FROM `".$INFO['base_tabl']. "`,`".$INFO['alias_tabl']."` WHERE  (`".$INFO['base_tabl']."`.id>='" . intval($_REQUEST['c']) . "') and ((UPPER(`".$INFO['base_tabl']. "`.dst_ntb)=UPPER(`".$INFO['alias_tabl']."`.name) and UPPER(`".$INFO['alias_tabl']."`.uid)='".$user_id."') or `dst_mac`='ff:ff:ff:ff:ff:ff') limit 1";
$e = mysql_query($query);
$s = @mysql_fetch_row($e);
$c=intval($s[0]);

$query="SELECT MIN(`".$INFO['base_tabl']."`.`id`)
 FROM `".$INFO['base_tabl']. "`,`".$INFO['alias_tabl']."` WHERE  (`".$INFO['base_tabl']."`.id>'" . intval($c) . "') and ((UPPER(`".$INFO['base_tabl']. "`.dst_ntb)=UPPER(`".$INFO['alias_tabl']."`.name) and UPPER(`".$INFO['alias_tabl']."`.uid)='".$user_id."') or `dst_mac`='ff:ff:ff:ff:ff:ff') limit 1";
$e = mysql_query($query);
$s = @mysql_fetch_row($e);
$cn=intval($s[0]);
if ($cn==0) {$cn=$c+1;};

$query="SELECT MAX(`".$INFO['base_tabl']."`.`id`)
 FROM `".$INFO['base_tabl']. "`,`".$INFO['alias_tabl']."` WHERE  (`".$INFO['base_tabl']."`.id<'" . intval($c) . "') and ((UPPER(`".$INFO['base_tabl']. "`.dst_ntb)=UPPER(`".$INFO['alias_tabl']."`.name) and UPPER(`".$INFO['alias_tabl']."`.uid)='".$user_id."') or `dst_mac`='ff:ff:ff:ff:ff:ff') limit 1";
$e = mysql_query($query);
$s = @mysql_fetch_row($e);
$cp=intval($s[0]);

//echo "$cmax $cn $c $cp";
$tpl->assign( array( "CP" => $cp));
$tpl->assign( array( "CN" => $cn));
$tpl->assign( array( "C" => $cmax));
$tpl->assign( array( "MPOPUPS" => ""));
	$tpl->parse("NAVIGATE", array("navigate"));

$query="SELECT * FROM `".$INFO['base_tabl']. "`,`".$INFO['alias_tabl']."` WHERE  (`".$INFO['base_tabl']."`.id='" . intval($c) . "') and ((UPPER(`".$INFO['base_tabl']. "`.dst_ntb)=UPPER(`".$INFO['alias_tabl']."`.name) and UPPER(`".$INFO['alias_tabl']."`.uid)='".$user_id."') or `dst_mac`='ff:ff:ff:ff:ff:ff') limit 1";
  if (isset($query)) {
$e = mysql_query($query) or die("Invalid query: " . mysql_error());

	include "popups.php";
	$tpl->assign(array( "CONTENT"	=> "{POPUPS}"));
};
}; # BROWSE END




# STAT BEGING
if ($jl_act=="stat") {
	include "stat.php";
	$tpl->assign(array( "NAVIGATE"	=> ""));
	$tpl->assign(array( "CONTENT"	=> "{STAT}"));
}; # STAT END

# SEARCH BEGING
if ($jl_act=="search") {
//	include "stat.php";
	$tpl->assign(array( "NAVIGATE"	=> ""));
	$tpl->assign(array( "CONTENT"	=> "{STAT}"));
	$tpl->parse("CONTENT", 	array("search"));
}; # SEARCH END


# SETTINGS BEGING
if ($jl_act=="settings" and $user_perm>0) {
	include "settings.php";
	$tpl->assign(array( "NAVIGATE"	=> ""));
	$tpl->assign(array( "CONTENT"	=> "{SETTINGS}"));
}; # SETTINGS END


if ($user_perm==1) {$tpl->assign(array( "LOGOUT1"=>"","LOGOUT2"=>""));};
	$tpl->parse("MAIN", 	array("main"));
?>